% !TeX encoding = ISO-8859-1
\chapter{nRF52DK}
\label{chap:nrf52dk}

\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{bilder/nrf52_board.jpg}
	\caption{Das nRF52 Development Kit}
	\label{fig:devkit}
\end{figure}

Das nRF52 DK ist eine single-Board Entwicklungsplattform, welche für die Verwendung von \ac{BLE}, ANT und proprietären 2.4GHz Protokollen ausgelegt ist. Herzstück des Kits ist das nRF52832 \ac{SoC}.

Die Header sind kompatibel mit allen Arduino Shields des Revisionsstandards 3, was das Kit enorm erweiterbar macht. Weiter besteht die Möglichkeit eine mitgelieferte NFC-Antenne anzuschliessen, um NFC-Tags zu lesen. Alle GPIOs sind via Header herausgeführt. Zusätzlich verfügt das Board über 4 LEDs und 4 Taster. 

\newpage

\section{Technische Übersicht}

\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{bilder/nrf52_schematic.jpg}
	\caption{Schema des nRF52DKs aus der Dokumentation von Nordic entnommen}
	\label{fig:schematic}
\end{figure}

Wie aus dem Schema ersichtlich wird, basiert das Developmentkit auf dem nRF52832 \ac{SoC}. In diesem Chip steckt ein 32bit ARM Cortex M4F, welcher mit 32MHz getaktet ist. Der Chip verfügt weiter über einen 2.4GHz Transceiver und \ac{NFC}.

\section{Installation der GNU ARM Embedded Toolchain}

Um die Funktion aller Tools und der SDK zu gewährleisten, sollten folgende Installationen ausschliesslich in der hier beschriebenen Reihenfolge ausgeführt werden. Da sich die Installation unter Ubuntu und Arch Linux unterscheiden, sind nachfolgend beide Varianten dokumentiert. 

Um die Software auf dem Hostsystem für das nRF52DK kompilieren zu können, benötigen wir eine sogenannte crosscompiler-toolchain. Für ARM basierte Controller ist hier die erste Wahl die gnu-arm-none-eabi Toolchain. Sie lässt sich von folgender Seite beziehen:

\url{https://launchpad.net/gcc-arm-embedded/+download}

Es gilt darauf zu achten, die neueste Version zu verwenden und sich zu notieren, welche Version heruntergeladen wurde, da diese später im Makefile angegeben werden muss. Die Software sollte im Verzeichnis /opt installiert werden. Die Binaries sollten mit den nötigen Rechten ausgestattet werden. Weiter empfiehlt es sich, symbolische Links zu generieren, um die Programme systemweit sichtbar zu machen.

Die Befehle dazu lauten:

\begin{lstlisting}[style=BashInputStyle]
    tar -xf gcc-arm-none-eabi-linux.tar.bz2 /opt/gcc-arm-none-eabi-tools
    ln -s /opt/gcc-arm-none-eabi-tools/bin/* /usr/local/bin/
\end{lstlisting}

Wichtig: Unter Arch Linux sollte unbedingt die aktuellste Version im Community Repository verwendet werden. Die gewünschte Software lässt sich wie folgt installieren:

\begin{lstlisting}[style=BashInputStyle]
    pacman -S community/arm-none-eabi-binutils
    pacman -S community/arm-none-eabi-newlib
    pacman -S community/arm-none-eabi-gcc
    pacman -S community/arm-none-eabi-gdb
\end{lstlisting}


\section{Installation der nordic SDK}

Nordic Semiconductor verfügt über ein Software Archiv von welchem alle benötigte Software bezogen werden kann. Das Archiv befindet sich unter folgendem Link:

\url{https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52-DK#Downloads}

Um mit dem nRF52 Entwicklungskit arbeiten zu können, benötigen wir folgende Softwarepakete:

\begin{enumerate}
    \item nRF5 SDK Zip File
    \item nRF5x-Command-Line-Tools-Linux64
\end{enumerate}

Im ersten Paket befinden sich alle Files, welche zur Entwicklung von Software auf dem nRF52dk notwendig sind. Darunter Makefiles, Linkerskripte und auch Beispielcode.
Im zweiten Paket befinden sich die Command-Line-Tools, welche es uns ermöglichen über die Kommandozeile mit dem nRF52 Entwicklungskit zu kommunizieren. Das wichtigste Tool ist nrfjprog, welches kompilierte Programme auf das Board hochladen kann.

Die SDK sowie die Command-Line-Tools sollten auf dem System unter dem Ordner /opt installiert werden und mit den nötigen Berechtigungen versehen werden. Ebenfalls sollten die Programme in einen Ordner gelinkt werden, welcher im Systempfad angegeben ist.

Die Befehle dazu lauten:
\begin{lstlisting}[style=BashInputStyle]
    tar -xf nRF5x-Command-Line-Tools-Linux64.tar /opt/
    ln -s /opt/nrfjprog/nrfjprog /usr/bin/nrfjprog
    ln -s /opt/mergehex/mergehex /usr/bin/mergehex
\end{lstlisting}

Unter Arch Linux lassen sich die Command Line Tools auch über das Arch User Repository beziehen. Dazu kann man den Pacman Wrapper ''yaourt'' verwenden:

\begin{lstlisting}[style=BashInputStyle]
    yaourt -S aur/nrf5x-command-line-tools 
\end{lstlisting}

\section{Installation des SEGGER JLink Debuggers}

Die Software von SEGGER, welche fürs Debuggen gebraucht wird, findet man unter folgendem Link:

\url{https://www.segger.com/downloads/jlink}

Das Paket ''J-Link Software and Documentation Pack'' enthält verschiedene Programme. Die Wichtigsten davon sind der JLinkCommander und der JLinkGDBServer. Über den Commander lässt sich die CPU des nRF52 vollständig via JTAG oder SWD Schnittstelle kontrollieren. Der JLinkGDBServer stellt auf dem Localhost einen Socket unter Port 2331 zur Verfügung, auf welchen man sich mit GDB verbinden kann.

Die JLink Toolchain sollte auf dem System unter dem Ordner /opt installiert werden und mit den nötigen Berechtigungen versehen werden. Die Programme sollten mittels symbolischen Links in einen Ordner gelinkt werden, welcher im Systempfad angegeben ist.

\begin{lstlisting}[style=BashInputStyle]
    mkdir /opt/SEGGER/JLink
    tar -xzf JLink_Linux_{VERSION}.tar.gz /opt/SEGGER/JLink
    ln -s /opt/SEGGER/JLink/JLinkExe /usr/bin/JLinkExe
    ln -s /opt/SEGGER/JLink/JLinkGDBServer /usr/bin/JLinkGDBServer
\end{lstlisting}

SEGGER bietet auch ein Debianpaket an. Dieses kann auf Systemen, welche über den Paketmanager DPKG verfügen, mittels \verb|dpkg -i JLink_linux.deb| installiert werden. Dadurch entfällt obiger Installationsaufwand.\newline

Unter ArchLinux lässt sich die Software auch aus dem Arch-User-Repository installieren, der Befehl dazu lautet:
\begin{lstlisting}[style=BashInputStyle]
    yaourt -S aur/jlink-software-and-documentation
\end{lstlisting}

\section{Verwendung des JLinkGDBServers}

Der folgende Befehl beschreibt das Starten des GDBJLinkServers von SEGGER. 

\begin{lstlisting}[style=BashInputStyle]
    JLinkGDBServer -Device nRF52832_xxAA -If SWD -Speed 4000 -Autoconnect 1
\end{lstlisting}

Der Server startet einen lokalen Socket und ist unter Port 1234 erreichbar.
Nachdem \ac{GDB} gestartet wurde, lässt sich über folgenden Befehl eine Verbindung mit dem Server herstellen:

\textbf{(gdb) target remote localhost:1234}

Alternativ kann auch eine Konfigurationsdatei für GDB angelegt werden. Dazu erstellt man im Home-Verzeichnis eine Datei mit dem Namen .gdbinit. Um automatisch auf den lokalen Server zu verbinden, ist lediglich die obere Zeile hinzufügen. 

\section{Verwendung von nrfjprog}

Nrfjprog ist Teil der Proprietären Softwarewerkzeuge der SDK von Nordic. Es unterstützt das Flashen von Hex-Binarys über SWD oder JTAG. Der Funktionsumfang ist sehr gross, daher sei an dieser Stelle auch noch aufs Helpfile verwiesen.

Um eine bereits kompilierte Beispielapplikation auf das nrf52 Board zu laden, sind folgende Befehle in dieser Reihenfolge auszuführen.

\begin{lstlisting}[style=BashInputStyle]
    nrfjprog --eraseall -f nrf52
    nrfjprog --program outdir/nrf52_pca10040/zephyr.hex -f nrf52
    nrfjprog --reset -f nrf52
\end{lstlisting}

Zeile 1 löscht den aktuellen Inhalt des Flashspeichers auf dem SoC.\newline
Zeile 2 flasht ein neues Binary in den Flashspeicher des SoC.\newline
Zeile 3 Resetet den SoC, alternativ kann auch der Hardwarereset betätigt werden.\newline

\clearpage

\section{nrf52dk-zephyr-tool}

Das nrf52-zephyr-tool ist ein Werkzeug, welches die noch fehlende Funktionalität des Zephyr Build Systemes fürs nRF52DK ersetzen soll. Es vereinfacht das Anlegen von neuen Projekten und bietet die Möglichkeit, ein Binary auf das Developmentkit zu laden. Die Bedienung funktioniert über ein \ac{CLI}.

Ein Aufruf der Helpfunktion erzeugt folgende Ausgabe:

\begin{lstlisting}[style=BashInputStyle]
Usage: ./nrf52dk_zephyr_tool.sh [options]

This script handles the creation and compilation of zephyr applications
for the nrf52dk. Make sure the Zephyr environment (zephyr-env.sh) is sourced! 
Otherwise the compilation will not work.

OPTIONS:
help                 Show this message
debug                Initializes the JLinkGDBServer for the nrf52 board
flash  ProjectPath   Flashes the previously built project
build  ProjectPath   Builds a zephyr application
create ProjectPath   Creates a new project folder with standard configuration
\end{lstlisting}

Die ganzen boardspezifischen Konfigurationen und eine Beispielapplikation wurden im Script mittels Base64 Codierung hinzugefügt. Es bedarf daher keiner weiteren Dateien um ein neues Projekt anzulegen.
Damit das Script ordnungsgemäss funktionert, muss folgendes gewährleistet sein:

\begin{enumerate}
	\item Das Zephyr-Environment ist in der aktuellen Shell gesourced
	\item Die Zephyr-SDK ist installiert
	\item Die nRF5x-Command-Line-Tools sind installiert
\end{enumerate}

Ein Aufruf des Scrips mit dem Argument \textbf{create} führt dazu, dass folgende Ordnerstruktur auf dem Filesystem angelegt wird:

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\linewidth]{bilder/myAwesomeProject.png}
	\caption{Angelegte Ordnerstruktur}
	\label{fig:tree}
\end{figure}

Das Projekt lässt sich mit dem Argument \textbf{build} kompilieren und anschliessend mit \textbf{flash} auf das Board laden. Der Debugserver von Nordic lässt sich mit \textbf{debug} starten. Anschliessend sollte es möglich sein, sich mittels GDB zu verbinden.

Eine wünschenswerte Erweiterung des Scripts wäre der automatische Download und die Installation der Nordic-SDK, der arm-none-eabi-Toolchain und der Zephyr-SDK. 
